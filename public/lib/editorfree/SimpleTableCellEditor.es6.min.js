"use strict";function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1;descriptor.configurable=!0;if("value" in descriptor)descriptor.writable=!0;Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){if(protoProps)_defineProperties(Constructor.prototype,protoProps);if(staticProps)_defineProperties(Constructor,staticProps);return Constructor}function _instanceof(left,right){if(right!=null&&typeof Symbol!=="undefined"&&right[Symbol.hasInstance]){return!!right[Symbol.hasInstance](left)}else{return left instanceof right}}function _classCallCheck(instance,Constructor){if(!_instanceof(instance,Constructor)){throw new TypeError("Cannot call a class as a function")}}window.onload=function(){if(!window.jQuery){throw "jQuery is not loaded"}};var SimpleTableCellEdition=function SimpleTableCellEdition(elem,_cellParams){_classCallCheck(this,SimpleTableCellEdition);this.Elem=elem;this.oldContent=$(elem).html();this.oldValue=_cellParams.internals.extractValue(elem);this.cellParams=_cellParams};var SimpleTableCellEditor=function(){function SimpleTableCellEditor(_tableId,_params){_classCallCheck(this,SimpleTableCellEditor);var _instance=this;_instance.EditionEndOrigin={OutsideTable:1,AnotherCell:2};if(typeof _tableId==='undefined')_tableId="table";this.active=!0;this.tableId=_tableId;this.params=_instance._GetExtendedEditorParams(_params);this.CellEdition=null;this._TryHandleDataTableReloadEvent();$(document).mouseup(function(e){var container=$("#".concat(_instance.tableId));if(!container.is(e.target)&&container.has(e.target).length===0){_instance._FreeCurrentCell(_instance.EditionEndOrigin.OutsideTable)}return})}_createClass(SimpleTableCellEditor,[{key:"SetEditable",value:function SetEditable(elem,_cellParams){var _instance=this;if(!_instance._isValidElem(elem))return;var cellParams=_instance._GetExtendedCellParams(_cellParams);$(elem).on('click',function(evt){if(!_instance.active)return;if($(this).hasClass(_instance.params.inEditClass))return;_instance._EditCell(this,cellParams)});$(elem).on('keydown',function(event){if(!_instance.active)return;if(!$(this).hasClass(_instance.params.inEditClass))return;_instance._HandleKeyPressed(event.which,this,cellParams)})}},{key:"SetEditableClass",value:function SetEditableClass(editableClass,_cellParams){var _instance=this;var cellParams=_instance._GetExtendedCellParams(_cellParams);$("#".concat(_instance.tableId)).on('click',"td.".concat(editableClass,":not(.").concat(_instance.params.inEditClass,")"),function(){if(!_instance.active)return;_instance._EditCell(this,cellParams)});$("#".concat(_instance.tableId)).on('keydown',"td.".concat(editableClass,".").concat(_instance.params.inEditClass),function(event){if(!_instance.active)return;_instance._HandleKeyPressed(event.which,this,cellParams)})}},{key:"Toggle",value:function Toggle(_active){if(typeof _active==='undefined')_active=!this.active;this.active=_active}},{key:"_HandleKeyPressed",value:function _HandleKeyPressed(which,elem,cellParams){if(cellParams.keys.validation.includes(which))this._FreeCell(elem,cellParams,!0);else if(cellParams.keys.cancellation.includes(which))this._FreeCell(elem,cellParams,!1)}},{key:"_EditCell",value:function _EditCell(elem,cellParams){var onEditEnterEvent=this._FireOnEditEnterEvent(elem);if(onEditEnterEvent.isDefaultPrevented())return;this._FreeCurrentCell(this.EditionEndOrigin.AnotherCell);this.CellEdition=new SimpleTableCellEdition(elem,cellParams);if(this.isDataTable){this.CellEdition.cellIndex=$("#".concat(this.tableId)).DataTable().cell($(elem)).index()}var oldVal=cellParams.internals.extractValue(elem);$(elem).addClass(this.params.inEditClass);cellParams.internals.renderEditor(elem,oldVal);this._FireOnEditEnteredEvent(elem,oldVal)}},{key:"_EndEditCell",value:function _EndEditCell(elem,cellParams){this._FreeCell(elem,cellParams,!0)}},{key:"_CancelEditCell",value:function _CancelEditCell(elem,cellParams){this._FreeCell(elem,cellParams,!1)}},{key:"_FreeCell",value:function _FreeCell(elem,cellParams,keepChanges){if(!this._isValidElem(elem)||this.CellEdition===null)return;var onEditExitEvent=this._FireOnEditExitEvent(elem,this.CellEdition.oldValue);if(onEditExitEvent.isDefaultPrevented())return;var newVal=cellParams.internals.extractEditorValue(elem);$(elem).removeClass(this.params.inEditClass);$(elem).html('');if(!cellParams.validation(newVal)||this.CellEdition.oldValue===newVal)keepChanges=!1;var formattedNewVal=cellParams.formatter(newVal);this._FireOnEditExitedEvent(elem,this.CellEdition.oldValue,formattedNewVal,keepChanges);if(keepChanges){cellParams.internals.renderValue(elem,formattedNewVal);this._FireEditedEvent(elem,this.CellEdition.oldValue,formattedNewVal)}else{$(elem).html(this.CellEdition.oldContent)}this.CellEdition=null}},{key:"_FreeCurrentCell",value:function _FreeCurrentCell(editionEndOrigin){var current=this._GetCurrentEdition();if(current===null)return;var keepChanges=!0;if(editionEndOrigin===this.EditionEndOrigin.OutsideTable&&current.cellParams.behaviour.outsideTableClickCauseCancellation)keepChanges=!1;if(editionEndOrigin===this.EditionEndOrigin.AnotherCell&&current.cellParams.behaviour.anotherCellClickCauseCancellation)keepChanges=!1;this._FreeCell(current.Elem,current.cellParams,keepChanges)}},{key:"_GetCurrentEdition",value:function _GetCurrentEdition(){return this.CellEdition===null?null:this.CellEdition}},{key:"_GetExtendedEditorParams",value:function _GetExtendedEditorParams(_params){var _instance=this;return $.extend(!0,{},_instance._GetDefaultEditorParams(),_params)}},{key:"_GetExtendedCellParams",value:function _GetExtendedCellParams(_cellParams){var _instance=this;return $.extend(!0,{},_instance._GetDefaultCellParams(),_cellParams)}},{key:"_FireOnEditEnterEvent",value:function _FireOnEditEnterEvent(elem){var evt=jQuery.Event("cell:onEditEnter",{element:elem});$("#".concat(this.tableId)).trigger(evt);return evt}},{key:"_FireOnEditEnteredEvent",value:function _FireOnEditEnteredEvent(elem,oldVal){$("#".concat(this.tableId)).trigger({type:"cell:onEditEntered",element:elem,oldValue:oldVal})}},{key:"_FireOnEditExitEvent",value:function _FireOnEditExitEvent(elem,oldVal){var evt=jQuery.Event("cell:onEditExit",{element:elem,oldValue:oldVal});$("#".concat(this.tableId)).trigger(evt);return evt}},{key:"_FireOnEditExitedEvent",value:function _FireOnEditExitedEvent(elem,oldVal,newVal,applied){$("#".concat(this.tableId)).trigger({type:"cell:onEditExited",element:elem,newValue:newVal,oldValue:oldVal,applied:applied})}},{key:"_FireEditedEvent",value:function _FireEditedEvent(elem,oldVal,newVal){$("#".concat(this.tableId)).trigger({type:"cell:edited",element:elem,newValue:newVal,oldValue:oldVal})}},{key:"_TryHandleDataTableReloadEvent",value:function _TryHandleDataTableReloadEvent(){var _instance=this;this.isDataTable=!1;try{if($.fn.DataTable.isDataTable("#".concat(_instance.tableId)))_instance.isDataTable=!0}catch(e){return}if(_instance.isDataTable){$("#".concat(_instance.tableId)).on('draw.dt',function(){if(_instance.CellEdition!==null&&_instance.CellEdition.Elem!==null){var node=$("#".concat(_instance.tableId)).DataTable().cell(_instance.CellEdition.cellIndex).node();_instance._EditCell(node,_instance.CellEdition.cellParams)}})}}},{key:"_GetDefaultEditorParams",value:function _GetDefaultEditorParams(){return{inEditClass:"inEdit"}}},{key:"_GetDefaultCellParams",value:function _GetDefaultCellParams(){return{validation:function validation(value){return!0},formatter:function formatter(value){return value},keys:{validation:[13],cancellation:[27]},behaviour:{outsideTableClickCauseCancellation:!1,anotherCellClickCauseCancellation:!1},internals:this._GetDefaultInternals()}}},{key:"_GetDefaultInternals",value:function _GetDefaultInternals(){return{renderValue:function renderValue(elem,formattedNewVal){$(elem).text(formattedNewVal)},renderEditor:function renderEditor(elem,oldVal){$(elem).html("<input type='text' style=\"width:100%; max-width:none\">");var input=$(elem).find('input');input.focus();input.val(oldVal)},extractEditorValue:function extractEditorValue(elem){return $(elem).find('input').val()},extractValue:function extractValue(elem){return $(elem).text()}}}},{key:"_isValidElem",value:function _isValidElem(elem){return elem!==null&&typeof elem!=='undefined'&&$(elem).length>0}}]);return SimpleTableCellEditor}()